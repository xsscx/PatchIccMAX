###############################################################
#
## Copyright (©) 2024-2025 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 03-DEC-2025 at 0800 EDT by David Hoyt (©)
#
## Intent: "head-mtx-os-release"
#
#
#
#
#
#
#
#
#
#
#
###############################################################

name: "head-mtx-os-release"

on:
  workflow_dispatch:

jobs:
  build:
    name: "Build on ${{ matrix.os }} with ${{ matrix.compiler }}"
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            compiler: gcc
          - os: ubuntu-22.04
            compiler: clang
          - os: macos-latest
            compiler: clang
          - os: macos-26
            compiler: clang
          - os: macos-15
            compiler: clang
          - os: macos-14
            compiler: clang
          - os: macos-13
            compiler: clang

    steps:
      - name: Checkout PR Source
        uses: actions/checkout@v4

      - name: Configure Git Identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
      - name: Install Build Dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get install -y \
               libxml2 libxml2-dev nlohmann-json3-dev build-essential   cmake libopencl-clang-dev libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev  libwxgtk-webview3.0-gtk3-dev wx3.0-headers libtiff5 libtiff5-dev libgtk-3-dev libcurl4-openssl-dev curl git llvm clang clang-tools
      - name: Install Build Dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install libpng nlohmann-json libxml2 wxwidgets libtiff jpeg
      - name: Build wxWidgets (Linux only)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          git clone https://github.com/wxWidgets/wxWidgets.git
          cd wxWidgets
          git submodule update --init --recursive
          ./configure --enable-debug --prefix=/usr/local
          make -j$(nproc)
          sudo make install
          sudo ldconfig
      - name: Set Compiler Environment
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi
      - name: CMake Configure
        run: |
          git -C .. show --stat --pretty=format:"Commit: %H%nAuthor: %an%nDate: %ad%n" HEAD | grep Commit || true
          cd Build
          if [[ "${{ matrix.os }}" == macos* ]]; then
            brew install libpng nlohmann-json libxml2 wxwidgets libtiff jpeg
            sudo rm -rf /Library/Frameworks/Mono.framework/Headers/png.h
            echo 'export PATH="/opt/homebrew/opt/jpeg/bin:$PATH"' >> ~/.bash_profile
            export CPPFLAGS="-I/opt/homebrew/opt/jpeg/include"
            export PKG_CONFIG_PATH="/opt/homebrew/opt/jpeg/lib/pkgconfig"
            export CFLAGS="-I$(brew --prefix libpng)/include -I$(brew --prefix jpeg)/include"
            export LDFLAGS="-L$(brew --prefix libpng)/lib -L$(brew --prefix jpeg)/lib"
          fi
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local \
                -DCMAKE_BUILD_TYPE=Release \
                -Wno-dev Cmake/
          echo "Starting build process..."
          make -j$(sysctl -n hw.ncpu 2>/dev/null || nproc)
          echo "Build process completed."
          echo "========= BEGIN INSIDE STUB for PR210 ========="
          cd ../Testing/
          echo "=== Updating PATH ==="
          for d in ../Build/Tools/*; do
            [ -d "$d" ] && export PATH="$(realpath "$d"):$PATH"
          done
          sh CreateAllProfiles.sh
          sh RunTests.sh
          cd HDR
          sh mkprofiles.sh
          cd ..
          cd CalcTest
          sh checkInvalidProfiles.sh
          cd ..
          cd mcs
          sh updateprev.sh
          sh updateprevWithBkgd.sh
          cd ..
          find . -iname "*.icc" | wc -l 
      - name: Verify Build Output
        run: |
          test -f Build/CMakeCache.txt && echo "CMake cache present" || (echo "Build failed" && exit 1)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iccmax-${{ matrix.os }}-${{ matrix.compiler }}-release
          path: Build

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: cmake-log-${{ matrix.os }}-${{ matrix.compiler }}
          path: Build/CMakeCache.txt

      - name: Host System Info
        run: |
          uname -a
          if [[ "${{ matrix.os }}" == macos* ]]; then
            sw_vers
            clang --version
            sysctl -a | grep machdep.cpu
          else
            cat /etc/os-release
            ${{ matrix.compiler }} --version
            lscpu
          fi
          free -m || true
          df -h

      # ---------- Summary ----------
      - name: Summary Report
        if: always()
        run: |
          echo "### Build Summary (${{ matrix.os }} • ${{ matrix.compiler }} • ${{ matrix.build_type }})" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Compiler: ${{ matrix.compiler }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Type: ${{ matrix.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Directory: PatchIccMAX/Build/" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: ${{ env.ARTIFACT_PREFIX }}" >> $GITHUB_STEP_SUMMARY
