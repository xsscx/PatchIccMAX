###############################################################
#
## Copyright (©) 2025 International Color Consortium. 
##                 All rights reserved. 
##                 https://color.org
#
#
## Intent: iccMAX-CI Runner for Matrix OS
#
## Last Updated: 24-JULY-2025 0000Z by David Hoyt 
#                Add Permission Block
## TODO: Push binary releases, tags etc...
#
## Comment: Known good and working
#
# Notes - Uses a Cache, Delete on Fail, Windows
#       - Uses a manual trigger to avoid wasting resources 
#
#
###############################################################

name: iccMAX-CI
permissions:
  contents: read
  
on:
  workflow_dispatch:

jobs:
  linux:
    name: "Linux ${{ matrix.compiler }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
    steps:
      - name: Checkout master
        uses: actions/checkout@v4

      - name: Install Dependencies
        shell: bash
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake gcc g++ clang clang-tools \
            libpng-dev libxml2 libxml2-dev libtiff-dev \
            nlohmann-json3-dev libwxgtk3.2-dev wx-common \
            python3 python3-pip curl git llvm

      - name: Set Compiler
        shell: bash
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Print Compiler Version
        shell: bash
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          echo "Compiler Version:" >> $GITHUB_STEP_SUMMARY
          $CC --version >> $GITHUB_STEP_SUMMARY

      - name: CMake Configure
        shell: bash
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd Build
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local \
                -DCMAKE_BUILD_TYPE=Release \
                -DENABLE_TOOLS=ON \
                -DENABLE_STATIC_LIBS=ON \
                -DENABLE_SHARED_LIBS=ON \
                -Wno-dev Cmake/

      - name: Build
        shell: bash
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd Build
          make -j$(nproc)

      - name: Verify CMake Cache
        shell: bash
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          if test -f Build/CMakeCache.txt; then
            echo "? Build OK" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "::error ::Build failed! CMakeCache.txt not found." | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iccmax-linux-${{ matrix.compiler }}
          path: Build

      - name: Summary Report
        if: always()
        run: |
          echo "### Linux Build Summary (${{ matrix.compiler }})" >> $GITHUB_STEP_SUMMARY
          echo "- Build Directory: Build/" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts Uploaded: iccmax-linux-${{ matrix.compiler }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Success" >> $GITHUB_STEP_SUMMARY

  macos:
    name: "macOS Clang"
    runs-on: macos-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4

      - name: Clone repository and install dependencies
        run: |
          echo "Cloning IccMAX repository..."
          git clone https://github.com/InternationalColorConsortium/DemoIccMAX.git
          cd DemoIccMAX
          echo "Installing Homebrew dependencies..."
          brew install libpng nlohmann-json libxml2 wxwidgets libtiff jpeg || echo "⚠️ Some dependencies might already be installed."
          echo "✔ Dependency installation complete."
  
      - name: CMake Configure
        run: |
          echo "Setting up CMake build configuration..."
          mkdir -p DemoIccMAX/Build
          cd DemoIccMAX/Build
          sudo rm -rf /Library/Frameworks/Mono.framework/Headers/png.h
          echo 'export PATH="/opt/homebrew/opt/jpeg/bin:$PATH"' >> /Users/runner/.bash_profile
          export CPPFLAGS="-I/opt/homebrew/opt/jpeg/include"
          export PKG_CONFIG_PATH="/opt/homebrew/opt/jpeg/lib/pkgconfig"
          export CFLAGS="-I$(brew --prefix libpng)/include -I$(brew --prefix jpeg)/include"
          export LDFLAGS="-L$(brew --prefix libpng)/lib -L$(brew --prefix jpeg)/lib"
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local \
                -DCMAKE_BUILD_TYPE=Release \
                -DENABLE_TOOLS=ON \
                -DENABLE_STATIC_LIBS=ON \
                -DENABLE_SHARED_LIBS=ON \
                -DJPEG_LIBRARY=$(brew --prefix jpeg)/lib/libjpeg.dylib \
                -DJPEG_INCLUDE_DIR=$(brew --prefix jpeg)/include \
                -Wno-dev Cmake/
          echo "✔ CMake configuration complete."
      
      - name: Build
        run: |
          echo "Starting build process..."
          cd DemoIccMAX/Build
          make -j$(sysctl -n hw.ncpu)
          echo "✔ Build process completed. Listing generated files..."
      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iccmax-macos-${{ matrix.compiler }}
          path: Build
      - name: Summary Report
        if: always()
        run: |
          echo "### macOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Build Directory: DemoIccMAX/Build/" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts Uploaded: iccmax-macos-clang" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
  windows:
    name: "Windows MSVC"
    runs-on: windows-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: powershell
    strategy:
      fail-fast: false
    steps:
      - name: Checkout PR source
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: UCI Gate 1 for Windows Powershell
        shell: pwsh
        env:
          POWERSHELL_TELEMETRY_OPTOUT: "1"
        run: |
         Set-StrictMode -Version Latest
         $ErrorActionPreference = 'Stop'
         $ProgressPreference = 'SilentlyContinue'
         
         # --- Disable telemetry sources (pwsh / dotnet / gh) ---
         $env:POWERSHELL_TELEMETRY_OPTOUT = "1"
         $env:DOTNET_CLI_TELEMETRY_OPTOUT = "1"
         $env:GH_NO_UPDATE_NOTIFIER = "1"
         $env:GH_PROMPT_DISABLED = "1"
         $env:NUGET_XMLDOC_MODE = "skip"
         
         # --- Validate workspace path (defense-in-depth) ---
         if (-not (Test-Path $env:GITHUB_WORKSPACE)) {
             throw "Invalid GITHUB_WORKSPACE path: $env:GITHUB_WORKSPACE"
         }
         
         # --- Remove tokens or uci that should not exist in PR CI ---
         foreach ($v in @(
             'GITHUB_TOKEN',
             'ACTIONS_RUNTIME_TOKEN',
             'ACTIONS_ID_TOKEN_REQUEST_URL',
             'ACTIONS_ID_TOKEN_REQUEST_TOKEN'
         )) {
             if (Test-Path "Env:$v") {
                 Remove-Item "Env:$v" -ErrorAction SilentlyContinue
             }
         }
         
         # --- Canonicalization then sanitize user controllable input ---
         function Canonicalize([string]$s) {
             if (-not $s) { return "" }
             $s = $s.Trim()
             $s = $s.Replace("`r","").Replace("`n","")
             $s = -join ($s.ToCharArray() | Where-Object { [int]$_ -ge 32 })
             return $s
         }
         
         # --- Canonicalize PR-controlled environment values ---
         $env:GITHUB_REF      = Canonicalize $env:GITHUB_REF
         $env:GITHUB_HEAD_REF = Canonicalize $env:GITHUB_HEAD_REF
         $env:GITHUB_BASE_REF = Canonicalize $env:GITHUB_BASE_REF
         
         # --- Harden Git configuration ---
         git config --global --add safe.directory "$env:GITHUB_WORKSPACE"
         git config --global credential.helper ""
         
         # --- PATH hardening: limit to trusted tool locations ---
         $trustedPath = @(
             "$env:SystemRoot\system32",
             "$env:SystemRoot",
             "$env:ProgramFiles\Git\bin",
             "$env:ProgramFiles\PowerShell\7"
         ) -join ';'
         $env:PATH = $trustedPath
         
          Write-Host "Finished UCI Gate 1 for pwsh" -ForegroundColor Green

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: UCI Gate 2 for Windows Powershell - Verify Branch Context
        shell: pwsh
        env:
          POWERSHELL_TELEMETRY_OPTOUT: "1"
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          Write-Host "Triggered by:  $env:GITHUB_EVENT_NAME"
          Write-Host "Base branch:   $env:GITHUB_BASE_REF"
          Write-Host "Head branch:   $env:GITHUB_HEAD_REF"
          Write-Host "Commit SHA:    $env:PR_HEAD_SHA"
          Write-Host "OS:            $env:RUNNER_OS"

      - name: Install dependencies and build
        shell: pwsh
        env:
          POWERSHELL_TELEMETRY_OPTOUT: "1"
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
            if (Test-Path Env:GITHUB_TOKEN) {
              Remove-Item Env:GITHUB_TOKEN -ErrorAction SilentlyContinue
            }
          Write-Host "============================= Starting Build =============================" -ForegroundColor Green
          Write-Host "C 2025 International Color Consortium. All rights reserved." -ForegroundColor Green
          
          $env:VSCMD_ARG_HOST_ARCH = "x64"
          $env:VSCMD_ARG_TGT_ARCH = "x64"
          
          $optDir = "C:\test"
          $vcpkgDir = "$optDir\vcpkg"
          $patchDir = "$optDir\DemoIccMAX"
          
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          
          if (-Not (Test-Path $optDir)) { New-Item -ItemType Directory -Path $optDir | Out-Null }
          if (-Not (Test-Path "$vcpkgDir\vcpkg.exe")) {
              git clone https://github.com/microsoft/vcpkg.git $vcpkgDir
              & "$vcpkgDir\bootstrap-vcpkg.bat"
          }
          if (-Not (Test-Path "$vcpkgDir\vcpkg.exe")) {
              Write-Host "? ERROR: vcpkg failed to install!" -ForegroundColor Red
              exit 1
          }
          pwd
          dir
          del vcpkg.json
          $packages = @(
          "libpng:x64-windows", "jpeg:x64-windows", "jpeg:x64-windows-static",
          "nlohmann-json:x64-windows", "nlohmann-json:x64-windows-static",
          "libxml2:x64-windows", "libxml2:x64-windows-static",
          "tiff:x64-windows", "tiff:x64-windows-static",
          "wxwidgets:x64-windows", "wxwidgets:x64-windows-static"
          )
          foreach ($pkg in $packages) { & "$vcpkgDir\vcpkg.exe" install $pkg }
      - name: Clone DemoIccMAX Repository
        shell: pwsh
        env:
          POWERSHELL_TELEMETRY_OPTOUT: "1"
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
            if (Test-Path Env:GITHUB_TOKEN) {
              Remove-Item Env:GITHUB_TOKEN -ErrorAction SilentlyContinue
            }
          $patchDir = "C:\test\DemoIccMAX"
          if (Test-Path $patchDir) { Remove-Item -Recurse -Force $patchDir }
          git clone https://github.com/InternationalColorConsortium/DemoIccMAX.git $patchDir
          cd $patchDir
      - name: Configure & Build with CMake
        shell: pwsh
        run: |
          cd C:\test\DemoIccMAX\Build\Cmake
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=C:/test/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DCMAKE_C_FLAGS="/MD /I C:/test/vcpkg/installed/x64-windows/include" `
            -DCMAKE_CXX_FLAGS="/MD /I C:/test/vcpkg/installed/x64-windows/include" `
            -DCMAKE_SHARED_LINKER_FLAGS="/LIBPATH:C:/test/vcpkg/installed/x64-windows/lib" `
            -DENABLE_TOOLS=ON `
            -DENABLE_SHARED_LIBS=ON `
            -DENABLE_STATIC_LIBS=ON `
            -DENABLE_TESTS=ON `
            -DENABLE_INSTALL_RIM=ON `
            -DENABLE_ICCXML=ON
          cmake --build build --config Release -- /m /maxcpucount:32
          Get-ChildItem -Recurse -Include *.exe -Path .\build_* | Where-Object { -not $_.PSIsContainer -and $_.FullName -notmatch '\\CMakeFiles\\' } | Select-Object FullName, Length | Sort-Object FullName
          Get-ChildItem -Recurse -Include *.lib -Path .\build_* | Where-Object { -not $_.PSIsContainer -and $_.FullName -notmatch '\\CMakeFiles\\' } | Select-Object FullName, Length | Sort-Object FullName
          Get-ChildItem -Recurse -Include *.exe,*.lib -Path .\build_* | Where-Object { -not $_.PSIsContainer -and $_.FullName -notmatch '\\CMakeFiles\\' } | Select-Object FullName, Length | Sort-Object FullName
      - name: Verify Build Output
        shell: pwsh
        env:
          POWERSHELL_TELEMETRY_OPTOUT: "1"
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
            if (Test-Path Env:GITHUB_TOKEN) {
              Remove-Item Env:GITHUB_TOKEN -ErrorAction SilentlyContinue
            }
          $cmakeCache = "C:\test\DemoIccMAX\Build\Cmake\build\CMakeCache.txt"
          if (Test-Path $cmakeCache) {
            Write-Host "? Build succeeded. CMake cache found."
          } else {
            Write-Host "? Build failed! No CMakeCache.txt found."
            exit 1
          }
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iccmax-windows-msvc
          path: C:\test\DemoIccMAX

      - name: Upload Windows Logs
        uses: actions/upload-artifact@v4
        with:
          name: iccmax-windows-logs
          path: C:\test\DemoIccMAX\Build\Cmake\build\CMakeCache.txt

      - name: Host System Info
        shell: pwsh
        env:
          POWERSHELL_TELEMETRY_OPTOUT: "1"
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
            if (Test-Path Env:GITHUB_TOKEN) {
              Remove-Item Env:GITHUB_TOKEN -ErrorAction SilentlyContinue
            }
          systeminfo
          Get-CimInstance -ClassName Win32_Processor
      - name: Summary Report
        if: always()
        run: |
          echo "### Windows Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Build Directory: DemoIccMAX/Build/" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts Uploaded: iccmax-macos-clang" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Success" >> $GITHUB_STEP_SUMMARY
