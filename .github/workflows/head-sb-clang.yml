###############################################################
#
## Copyright (Â©) 2024 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 31-OCT-2025 at 1200Z by David Hoyt
#
#
#
## Intent: head-sb-clang
#
## TODO:  
#
#
###############################################################

name: "head-sb-clang"

on:
  workflow_dispatch:

jobs:
  build-linux:
    name: Build and Test Linux with scan-build from HEAD
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    strategy:
      fail-fast: false

    steps:
      - name: Checkout master
        uses: actions/checkout@v4

      # Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake gcc g++ clang clang-tools libpng-dev libxml2 libxml2-dev libtiff-dev nlohmann-json3-dev libwxgtk3.2-dev wx-common python3 python3-pip curl git llvm
      # Configure the build with scan-build
      - name: Configure the build with scan-build at HEAD
        run: |
          echo "=== Configuring PR210 ==="
          git clone https://github.com/InternationalColorConsortium/iccDEV.git
          cd iccDEV
          git branch
          git status
          cd Build
          export CC=clang
          export CXX=clang++
          scan-build -stats --status-bugs --keep-going --keep-empty --force-analyze-debug-code --show-description --use-cc=clang --use-c++=clang++ cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON Cmake/

      # Run scan-build for static analysis
      - name: Run scan-build for static analysis
        run: |
          pwd
          cd iccDEV
          pwd
          ls
          cd Build
          pwd
          ls
          scan-build  -stats --status-bugs --keep-going --keep-empty --force-analyze-debug-code  --show-description --use-cc=clang --use-c++=clang++  -stats --status-bugs --keep-going --keep-empty --use-cc=clang --use-c++=clang++ -o scan-build-reports make -j"$(nproc)"
        continue-on-error: true 

      # Upload scan-build reports
      - name: Upload scan-build reports
        uses: actions/upload-artifact@v4
        with:
          name: scan-build-reports
          path: iccDEV/Build/scan-build-reports/

      # Upload built binaries as artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: master-build-linux
          path: iccDEV/Build/

      # Upload build logs
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: iccDEV/Build/CMakeCache.txt
      - name: Summary Report
        if: always()
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Build Directory: iccDEV/Build/" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts Uploaded: scan-build-reports, master-build-linux, build-logs" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
