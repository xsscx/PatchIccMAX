###############################################################
#
## Copyright (Â©) 2024-2025 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 23-OCT-2025 1200Z by David Hoyt
#
## Intent: Cmake testing / build pr180-branch-win
#
## TODO: Add Unit Test Suite
#
#
#
#
#
#
#
#
#
###############################################################

name: pr180-branch-win

permissions:
  contents: read
  pull-requests: read

on:
  workflow_dispatch:
  workflow_call:

concurrency:
  group: child-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.job }}
  cancel-in-progress: true

env:
  GH_REPO: ${{ github.repository }}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1
  RUN_URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
  PR: ${{ github.event.number }}

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    strategy:
      fail-fast: false

    steps:
      - name: Checkout PR source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Verify Branch Context
        run: |
          echo "Triggered by:  ${{ github.event_name }}"
          echo "Base branch:   ${{ github.base_ref }}"
          echo "Head branch:   ${{ github.head_ref }}"
          echo "Commit SHA:    ${{ github.event.pull_request.head.sha }}"
          echo "Build Type:    ${{ matrix.build_type }}"
          echo "Compiler:      ${{ matrix.compiler }}"
          echo "OS:            ${{ runner.os }}"
      - name: Install dependencies and build
        run: |
          Write-Host "========= Building pr180 branch... ================`n"
          git clone https://github.com/InternationalColorConsortium/iccDEV.git
          cd iccDEV
          git branch
          git status
          Write-Host "========= Fetching Deps... ================`n"
          Start-BitsTransfer -Source "https://xss.cx/2025/11/vcpkg/vcpkg-exported-deps.zip" -Destination "deps.zip"
          Write-Host "========= Extracting Deps... ================`n"
          tar -xf deps.zip
          cd Build/Cmake
          Write-Host "========= Building... ================`n"  
          cmake  -B build -S . -DCMAKE_TOOLCHAIN_FILE="..\..\scripts\buildsystems\vcpkg.cmake" -DVCPKG_MANIFEST_MODE=OFF -DCMAKE_BUILD_TYPE=Debug  -Wno-dev
          cmake --build build -- /m /maxcpucount
          cmake --build build -- /m /maxcpucount          
          $exeDirs = Get-ChildItem -Recurse -File -Include *.exe -Path .\build\ |
              Where-Object { $_.FullName -match 'iccdev' -and $_.FullName -notmatch '\\CMakeFiles\\' -and $_.Name -notmatch '^CMake(C|CXX)CompilerId\.exe$' } |
              ForEach-Object { Split-Path $_.FullName -Parent } |
              Sort-Object -Unique
          $env:PATH = ($exeDirs -join ';') + ';' + $env:PATH
          $env:PATH -split ';' | Select-String "icc"
          $toolDirs = Get-ChildItem -Recurse -File -Include *.exe -Path .\Tools\ | ForEach-Object { Split-Path -Parent $_.FullName } | Sort-Object -Unique
          $env:PATH = ($toolDirs -join ';') + ';' + $env:PATH
          $env:PATH -split ';'
          pwd
          cd ..\..\Testing
          .\CreateAllProfiles.bat
          .\RunTests.bat
          cd CalcTest\
          .\checkInvalidProfiles.bat
          .\runtests.bat
          cd ..\Display
          .\RunProtoTests.bat
          cd ..\HDR
          .\mkprofiles.bat
          cd ..\mcs\
          .\updateprev.bat
          .\updateprevWithBkgd.bat
          cd ..\Overprint
          .\RunTests.bat
          cd ..
          cd hybrid
          .\BuildAndTest.bat
          cd ..
          cd ..
          pwd
          # Collect .icc profile information
          $profiles = Get-ChildItem -Path . -Filter "*.icc" -Recurse -File
          $totalCount = $profiles.Count
          
          # Group profiles by directory
          $groupedProfiles = $profiles | Group-Object { $_.Directory.FullName }
          
          # Generate Summary Report
          Write-Host "`n========================="
          Write-Host " ICC Profile Report"
          Write-Host "========================="
          
          # Print count per subdirectory
          foreach ($group in $groupedProfiles) {
              Write-Host ("{0}: {1} .icc profiles" -f $group.Name, $group.Count)
          }
          
          Write-Host "`nTotal .icc profiles found: $totalCount"
          Write-Host "=========================`n"
          
          Write-Host "All Done!"
      - name: GitHub Summary
        if: always()
        run: |
          echo "## ðŸ§± CMake Windows Build Summary" >> %GITHUB_STEP_SUMMARY%
          echo "Repository: ${{ github.repository }}" >> %GITHUB_STEP_SUMMARY%
          echo "Run URL: [View Logs](${{ env.RUN_URL }})" >> %GITHUB_STEP_SUMMARY%
          echo "Triggered by: ${{ github.event_name }}" >> %GITHUB_STEP_SUMMARY%
          echo "Commit SHA: ${{ github.event.pull_request.head.sha || github.sha }}" >> %GITHUB_STEP_SUMMARY%
          echo "Build Type: ${{ matrix.build_type }}" >> %GITHUB_STEP_SUMMARY%
          echo "Runner OS: ${{ runner.os }}" >> %GITHUB_STEP_SUMMARY%
          echo "âœ… Build completed successfully on Windows with CMake and vcpkg." >> %GITHUB_STEP_SUMMARY%
