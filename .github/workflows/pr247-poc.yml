###############################################################
#
## Copyright (Â©) 2024-2025 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 20-NOV-2025 1330Z by David Hoyt
#
## Intent: Cmake testing / build
#
## TODO: Add Unit Test Suite
#
#
#
#
#
#
#
#
#
###############################################################

name: pr247-poc-repro

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Collect Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@v2
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git pkg-config
          sudo apt-get install -y \
            build-essential cmake gcc g++ clang clang-tools \
            libpng-dev libxml2 libxml2-dev libtiff-dev \
            nlohmann-json3-dev libwxgtk3.2-dev wx-common \
            python3 python3-pip curl git llvm zsh
          echo "Dependencies installed."
      - name: Configure
        run: |
          git clone https://github.com/InternationalColorConsortium/iccDEV.git
          cd iccDEV
          git fetch origin pull/247/head:pr-247
          git checkout pr-247
          git show --stat --pretty=format:"Commit: %H%nAuthor: %an%nDate: %ad%n" HEAD | grep Commit || true
          git branch
          git status
          cd Build
          export CXX=clang++
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local -DCMAKE_BUILD_TYPE=Debug -Wno-dev -DCMAKE_CXX_FLAGS="-g -fsanitize=address,undefined -fno-omit-frame-pointer" Cmake/
          make -j$(nproc)
          echo "========= BEGIN INSIDE STUB for PR247 ========="
          cd ../Testing/
          echo "=== Updating PATH ==="
           for d in ../Build/Tools/*; do
            [ -d "$d" ] && export PATH="$(realpath "$d"):$PATH"
           done
           pwd
           echo "========= Start undefined-behavior Test ... PR247 ========="
           wget https://raw.githubusercontent.com/xsscx/Commodity-Injection-Signatures/refs/heads/master/xml/icc/sRGB_D65_colorimetric_61477.xml
           wget https://raw.githubusercontent.com/xsscx/Commodity-Injection-Signatures/refs/heads/master/xml/icc/sRGB_D65_colorimetric_8590.xml
           wget https://raw.githubusercontent.com/xsscx/Commodity-Injection-Signatures/refs/heads/master/xml/icc/sRGB_D65_colorimetric_448.xml
           wget https://raw.githubusercontent.com/xsscx/Commodity-Injection-Signatures/refs/heads/master/xml/icc/sRGB_D65_colorimetric_20483.xml
           iccFromXml sRGB_D65_colorimetric_61477.xml sRGB_D65_colorimetric_61477.icc
           iccFromXml sRGB_D65_colorimetric_8590.xml sRGB_D65_colorimetric_8590.icc
           iccFromXml sRGB_D65_colorimetric_448.xml sRGB_D65_colorimetric_448.icc
           iccFromXml sRGB_D65_colorimetric_20483.xml sRGB_D65_colorimetric_20483.icc
           git show --stat --pretty=format:"Commit: %H%nAuthor: %an%nDate: %ad%n" HEAD | grep Commit
           git branch
           date
