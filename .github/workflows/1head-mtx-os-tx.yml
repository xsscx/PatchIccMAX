###############################################################
#
## Copyright (Â©) 2024 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 27-NOV-2025 at 2000 EST by David Hoyt (Â©)
#
## Intent: 1head-mtx-os-tx
#
## TODO: 
#
#
###############################################################

name: "1head-mtx-os-tx"

on:
  workflow_dispatch:

jobs:
  build:
    name: "ðŸ”§ Build on ${{ matrix.os }} with ${{ matrix.compiler }}"
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            compiler: gcc
            build_type: Release
          - os: ubuntu-22.04
            compiler: gcc
            build_type: Debug
          - os: ubuntu-22.04
            compiler: clang
            build_type: Release
          - os: ubuntu-22.04
            compiler: clang
            build_type: Debug
          - os: macos-latest
            compiler: clang
            build_type: Release
          - os: macos-latest
            compiler: clang
            build_type: Debug
          - os: macos-26
            compiler: clang
            build_type: Release
          - os: macos-26
            compiler: clang
            build_type: Debug
          - os: macos-15
            compiler: clang
            build_type: Release
          - os: macos-15
            compiler: clang
            build_type: Debug
          - os: macos-14
            compiler: clang
            build_type: Release
          - os: macos-14
            compiler: clang
            build_type: Debug

    steps:
      - name: Checkout PR Source
        uses: actions/checkout@v4

      - name: Configure Git Identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
      - name: Install Build Dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get install  --fix-missing -y \
               libxml2 libxml2-dev nlohmann-json3-dev build-essential   cmake libopencl-clang-dev libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev  libwxgtk-webview3.0-gtk3-dev wx3.0-headers libtiff5 libtiff5-dev libgtk-3-dev libcurl4-openssl-dev curl git llvm clang clang-tools
      - name: Install Build Dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew upgrade
          brew install libpng nlohmann-json libxml2 wxwidgets libtiff jpeg
      - name: Build wxWidgets (Linux only)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          git clone https://github.com/wxWidgets/wxWidgets.git
          cd wxWidgets
          git submodule update --init --recursive
          ./configure --enable-debug --prefix=/usr/local
          make -j$(nproc)
          sudo make install
          sudo ldconfig
      - name: Set Compiler Environment
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi
      - name: CMake Configure
        run: |
          git -C .. show --stat --pretty=format:"Commit: %H%nAuthor: %an%nDate: %ad%n" HEAD | grep Commit || true
          cd Build
          if [[ "${{ matrix.os }}" == macos* ]]; then
            brew install libpng nlohmann-json libxml2 wxwidgets libtiff jpeg
            sudo rm -rf /Library/Frameworks/Mono.framework/Headers/png.h
            echo 'export PATH="/opt/homebrew/opt/jpeg/bin:$PATH"' >> ~/.bash_profile
            export CPPFLAGS="-I/opt/homebrew/opt/jpeg/include"
            export PKG_CONFIG_PATH="/opt/homebrew/opt/jpeg/lib/pkgconfig"
            export CFLAGS="-I$(brew --prefix libpng)/include -I$(brew --prefix jpeg)/include"
            export LDFLAGS="-L$(brew --prefix libpng)/lib -L$(brew --prefix jpeg)/lib"
          fi
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local \
                -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -Wno-dev Cmake/
          echo "Starting build process..."
          make -j$(sysctl -n hw.ncpu 2>/dev/null || nproc)
          echo "Build process completed."
          echo "========= BEGIN INSIDE STUB ========="
          cd ../Testing || { echo "cd ../Testing failed" >&2; exit 1; }

            for d in ../Build/Tools/*; do
              if [ -d "$d" ]; then
                abs="$(realpath "$d" 2>/dev/null || true)"
                [ -n "$abs" ] && export PATH="$abs:$PATH"
              fi
            done
          echo "Creating Profiles"
          sh CreateAllProfiles.sh
          echo "RunTest.sh"
          sh RunTests.sh
          cd HDR
          sh mkprofiles.sh
          cd ..
          cd CalcTest
          echo "CalcTest invalid profiles check"
          sh checkInvalidProfiles.sh
          cd ..
          cd mcs
          sh updateprev.sh
          sh updateprevWithBkgd.sh
          cd ..

          echo "========= INSIDE STUB EXIT ========="
          
      - name: Verify Build Output
        run: |
          test -f Build/CMakeCache.txt \
            && echo "CMake cache present" \
            || (echo "Build failed" && exit 1)

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iccmax-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: Build/
          if-no-files-found: error

      - name: ðŸ“„ Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: cmake-log-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: Build/CMakeCache.txt
          if-no-files-found: error

      - name: Host System Info
        run: |
          uname -a
          if [[ "${{ matrix.os }}" == macos* ]]; then
            sw_vers
            clang --version
            sysctl -a | grep machdep.cpu
          else
            cat /etc/os-release
            ${{ matrix.compiler }} --version
            lscpu
          fi
          free -m || true
          df -h

      # ---------- Summary ----------
      - name: Summary Report
        if: always()
        run: |
          echo "### Build Summary (${{ matrix.os }} â€¢ ${{ matrix.compiler }} â€¢ ${{ matrix.build_type }})" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Compiler: ${{ matrix.compiler }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Type: ${{ matrix.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Directory: PatchIccMAX/Build/" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: ${{ env.ARTIFACT_PREFIX }}" >> $GITHUB_STEP_SUMMARY
