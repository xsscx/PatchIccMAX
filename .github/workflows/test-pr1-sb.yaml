###############################################################
#
## Copyright (©) 2024-2025 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 04-NOV-2025 1200Z by David Hoyt
#
#
#
#
#
#
#
#
#
#
#
#
#
###############################################################

name: PR Scan-Build (Ubuntu)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - test
      - master
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}
  cancel-in-progress: true

env:
  GH_REPO: ${{ github.repository }}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1
  RUN_URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
  PR: ${{ github.event.number }}

jobs:
  scan-build:
    name: Ubuntu • Clang Static Analysis
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    continue-on-error: true

    steps:
      - name: Checkout PR Source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Verify Branch Context
        run: |
          echo "Triggered by:  ${{ github.event_name }}"
          echo "Base branch:   ${{ github.base_ref }}"
          echo "Head branch:   ${{ github.head_ref }}"
          echo "Commit SHA:    ${{ github.event.pull_request.head.sha }}"
          echo "OS:            ubuntu-latest"
          echo "Build Type:    Release"
          echo "Static Analysis: Enabled (scan-build)"

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            clang clang-tools build-essential cmake \
            libpng-dev libxml2-dev libtiff-dev \
            nlohmann-json3-dev libwxgtk3.2-dev wx-common \
            python3 python3-pip curl git llvm

      - name: Prepare Environment
        run: |
          export CC=clang
          export CXX=clang++
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "Compiler: $($CC --version | head -n 1)"
          mkdir -p Build

      - name: Run scan-build Configuration
        run: |
          cd Build
          echo "::group::CMake Configure (scan-build)"
          scan-build cmake \
            -DCMAKE_INSTALL_PREFIX=$HOME/.local \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TOOLS=ON \
            -Wno-dev Cmake/ || true
          echo "::endgroup::"

      - name: Run scan-build Build
        run: |
          cd Build
          echo "::group::scan-build Analysis"
          scan-build --status-bugs --keep-going -o scan-build-reports \
            make -j$(nproc) || true
          echo "::endgroup::"
          echo "scan-build finished (errors ignored for CI success)."

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-build-reports
          path: Build/scan-build-reports

      - name: Summary Report
        if: always()
        run: |
          echo "### Static Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
          echo "- Compiler: clang" >> $GITHUB_STEP_SUMMARY
          echo "- Analysis Tool: scan-build" >> $GITHUB_STEP_SUMMARY
          echo "- Build Type: Release" >> $GITHUB_STEP_SUMMARY
          echo "- Reports: Build/scan-build-reports" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Always Success (non-blocking)" >> $GITHUB_STEP_SUMMARY
          echo "- Run URL: $RUN_URL" >> $GITHUB_STEP_SUMMARY