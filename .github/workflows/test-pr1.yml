###############################################################
#
## Copyright (Â©) 2024-2025 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 04-NOV-2025 1200Z by David Hoyt
#
#
#
#
#
#
#
#
#
#
#
#
#
###############################################################

name: "PR Unix Build"

permissions:
  contents: read
  pull-requests: read

on:
  # Allow manual runs
  workflow_dispatch:

  # Allow reuse by other workflows
  workflow_call:
    inputs:
      os-list:
        description: "List of operating systems"
        required: false
        default: '["ubuntu-latest", "macos-latest"]'
        type: string
      build-types:
        description: "Build types"
        required: false
        default: '["Release", "Debug"]'
        type: string
      compilers:
        description: "Compiler list"
        required: false
        default: '["gcc", "clang"]'
        type: string

concurrency:
  group: child-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.job }}
  cancel-in-progress: true

env:
  GH_REPO: ${{ github.repository }}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1
  RUN_URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
  PR: ${{ github.event.number }}

jobs:
  build:
    name: "${{ matrix.os }} â€¢ ${{ matrix.compiler }} â€¢ ${{ matrix.build_type }}"
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(inputs.os-list || '["ubuntu-latest", "macos-latest"]') }}
        compiler: ${{ fromJson(inputs.compilers || '["gcc", "clang"]') }}
        build_type: ${{ fromJson(inputs.build-types || '["Release", "Debug"]') }}
        exclude:
          - os: macos-latest
            compiler: gcc

    steps:
      - name: Checkout PR source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Verify Branch Context
        run: |
          echo "Triggered by:  ${{ github.event_name }}"
          echo "Base branch:   ${{ github.base_ref }}"
          echo "Head branch:   ${{ github.head_ref }}"
          echo "Commit SHA:    ${{ github.event.pull_request.head.sha }}"
          echo "Build Type:    ${{ matrix.build_type }}"
          echo "Compiler:      ${{ matrix.compiler }}"
          echo "OS:            ${{ matrix.os }}"

      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake gcc g++ clang clang-tools \
            libpng-dev libxml2 libxml2-dev libtiff-dev \
            nlohmann-json3-dev libwxgtk3.2-dev wx-common \
            python3 python3-pip curl git llvm

      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake llvm wxwidgets libpng libtiff libxml2 nlohmann-json

      - name: Set Compiler
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Print Compiler Version
        run: |
          echo "### Compiler Info" >> $GITHUB_STEP_SUMMARY
          echo "Using compiler: $CC / $CXX" >> $GITHUB_STEP_SUMMARY
          $CC --version >> $GITHUB_STEP_SUMMARY
          $CXX --version >> $GITHUB_STEP_SUMMARY

      - name: Configure CMake
        run: |
          echo "Configuring CMake project..."
          mkdir -p Build
          cd Build
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_C_COMPILER=$CC \
                -DCMAKE_CXX_COMPILER=$CXX \
                 Cmake
          echo "::group::CMake Cache"
          cat CMakeCache.txt || true
          echo "::endgroup::"

      - name: Build
        run: |
          echo "Starting build..."
          cd Build
          echo "Compiler: $CC ($($CC --version | head -n 1))"
          echo "CMake build type: ${{ matrix.build_type }}"
          make -j$(nproc || sysctl -n hw.logicalcpu)
          echo "Build complete."

      - name: Summary Report
        if: always()
        run: |
          echo "## ðŸ§± PR CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **OS:**         ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compiler:**   ${{ matrix.compiler }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** ${{ matrix.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts:**  Omitted iccmax-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:**     ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run URL:**    $RUN_URL" >> $GITHUB_STEP_SUMMARY
