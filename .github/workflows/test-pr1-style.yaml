###############################################################
#
## Copyright (©) 2024-2025 David H Hoyt. All rights reserved.
##                 https://srd.cx
##
## Last Updated: 04-NOV-2025 1200Z by David Hoyt
#
#
#
#
#
#
#
#
#
#
#
#
#
###############################################################

name: PR Lint & Style (Ubuntu)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - test
      - master
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number }}
  cancel-in-progress: true

env:
  GH_REPO: ${{ github.repository }}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1
  RUN_URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
  PR: ${{ github.event.number }}

jobs:
  quality-check:
    name: Ubuntu • Cppcheck • Clang-Tidy • Format
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    continue-on-error: true

    steps:
      - name: Checkout PR Source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Verify Branch Context
        run: |
          echo "Triggered by:  ${{ github.event_name }}"
          echo "Base branch:   ${{ github.base_ref }}"
          echo "Head branch:   ${{ github.head_ref }}"
          echo "Commit SHA:    ${{ github.event.pull_request.head.sha }}"
          echo "OS:            ubuntu-latest"
          echo "Checks:        cppcheck, clang-tidy, clang-format"

      - name: Run clang-tidy (non-blocking)
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git pkg-config
          sudo apt-get install -y \
          build-essential cmake gcc g++ clang clang-tools \
          libpng-dev libxml2 libxml2-dev libtiff-dev \
          nlohmann-json3-dev libwxgtk3.2-dev wx-common \
          python3 python3-pip curl git llvm zsh
          cd Build
          cmake Cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          make -j32
          echo "::group::Running clang-tidy..."
          find ../ -name "*.cpp" | head -50 | xargs clang-tidy \
            --quiet --warnings-as-errors=-* \
            -- -std=c++17 -I../include || true
          echo "::endgroup::"

      - name: Run clang-format Diff (non-blocking)
        continue-on-error: true
        run: |
          echo "::group::Checking formatting..."
          run-clang-tidy -p build -header-filter='.*' -checks='modernize-*,readability-*,cppcoreguidelines-*'
          run-clang-tidy -p Build -header-filter='.*' -checks='modernize-*,readability-*,cppcoreguidelines-*'
          run-clang-tidy -p Build -header-filter='.*' -checks='modernize-*,readability-*,cppcoreguidelines-*'
          run-clang-tidy -p Build -header-filter='.*'
          run-clang-tidy -p build -checks='modernize-*,readability-*,cppcoreguidelines-*' -quiet > reports/cppcheck/cppcheck/clang_tidy_report.txt
          run-clang-tidy -p Build -checks='modernize-*,readability-*,cppcoreguidelines-*' -quiet > reports/cppcheck/cppcheck/clang_tidy_report.txt
          echo "::endgroup::"

      - name: Run cppcheck (non-blocking)
        continue-on-error: true
        run: |
          mkdir -p reports/cppcheck
          echo "::group::Running cppcheck..."
          cppcheck --enable=all --inconclusive --std=c++17 --quiet --force . 2>  reports/cppcheck/cppcheck_report.txt || true
          echo "::endgroup::"
          echo "cppcheck results saved to reports/cppcheck/cppcheck.xml"

      - name: Collect Reports
        if: always()
        run: |
          mkdir -p artifacts
          cp -r reports artifacts/ || true
          echo "Reports collected under artifacts/"

      - name: Upload Lint Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: artifacts/

      - name: Summary Report
        if: always()
        run: |
          echo "### Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
          echo "- Tools: cppcheck, clang-tidy, clang-format" >> $GITHUB_STEP_SUMMARY
          echo "- Behavior: Non-blocking (continue-on-error=true)" >> $GITHUB_STEP_SUMMARY
          echo "- Reports: lint-reports (cppcheck.xml + logs)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Always Success" >> $GITHUB_STEP_SUMMARY
          echo "- Run URL: $RUN_URL" >> $GITHUB_STEP_SUMMARY
